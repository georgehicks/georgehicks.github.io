<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus App 2025.7.20.21</title>
    <!-- PWA additions -->
    <link rel="canonical" href="https://georgehicks.github.io/focus-app/" />
    <link rel="manifest" href="/focus-app/manifest.webmanifest">
    <meta name="theme-color" content="#a1c4fd" />
    <!-- For iOS support -->
    <link rel="apple-touch-icon" sizes="192x192" href="/focus-app/icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/focus-app/icon-512.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="#a1c4fd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- End PWA additions -->
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            opacity: 0.8;
            color: #555;
            background: #f9f9f9;
            font-size: 0.9em;
            position: relative;
        }
        body.dark-mode {
            background: #222;
            color: #ccc;
        }
        a {
            cursor: pointer;
        }
        h1 {
            font-size: 1em;
            color: #888;
            margin-bottom: 5px;
            text-align: center;
        }
        nav ul {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        nav li {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        nav a {
            text-decoration: none;
            padding: 3px 6px;
            background: #eee;
            color: #777;
            border-radius: 5px;
            border: none;
            font-size: 0.9em;
            cursor: pointer;
        }
        nav a.active {
            color: #fff;
        }
        nav a#tasksLink.active {
            background: #a1c4fd;
        }
        nav a#summaryLink.active {
            background: #ffd3a1;
        }
        nav a#agendaLink.active {
            background: #d1a1fd;
        }
        nav a#focusLink.active {
            background: #a1c4fd;
        }
        nav a#restLink.active {
            background: #a1fda1;
        }
        nav a.pulsate {
            animation: pulseRed 1s infinite;
        }
        @keyframes pulseRed {
            0% {
                background: #fda1a1;
            }

            50% {
                background: #eee;
            }

            100% {
                background: #fda1a1;
            }
        }
        section {
            display: none;
        }

        section.active {
            display: block;
        }

        #taskTextarea {
            width: 100%;
            height: 500px;
            font-family: monospace;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            color: #555;
            font-size: 0.9em;
            overflow: auto;
        }

        #taskTextarea.dark-mode {
            background: #333;
            color: #ccc;
            border-color: #555;
        }

        #taskSelect {
            font-size: 1em;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: transparent;
            color: #888;
        }

        #taskSelect.dark-mode {
            background: #333;
            color: #ccc;
            border-color: #555;
        }

        #stepInput {
            font-size: 1.2em;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: transparent;
            color: #888;
        }

        #stepInput.dark-mode {
            background: #333;
            color: #ccc;
            border-color: #555;
        }

        #notesTextarea {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
            overflow: auto;
        }

        #notesTextarea.dark-mode {
            background: #333;
            color: #ccc;
            border-color: #555;
        }

        #saveTasksBtn,
        #saveFocusBtn {
            display: none;
            margin-top: 5px;
            padding: 3px 6px;
            background: #d4f4d4;
            color: #555;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em;
        }

        #saveTasksBtn.dark-mode,
        #saveFocusBtn.dark-mode {
            background: #2a4d2a;
            color: #ccc;
        }

        #syncLink {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 0.8em;
            color: #777;
            text-decoration: none;
            cursor: pointer;
        }

        #syncLink.dark-mode {
            color: #ccc;
        }

        #settingsContainer {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #f9f9f9;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            z-index: 1000;
        }

        #settingsContainer.dark-mode {
            background: #333;
            border-color: #555;
        }

        #activeIndicator {
            position: fixed;
            bottom: 10px;
            left: 40px;
            font-size: 0.8em;
            color: #777;
        }

        #activeIndicator.dark-mode {
            color: #ccc;
        }
    </style>
</head>
<body>
    <span>Focus App</span>
    <div id="timeBox">
        <div id="remainingBar"></div>
        <div id="currentTime"></div>
    </div>
    <div id="nextMeeting"></div>
    <nav>
        <ul>
            <li><a href="#tasks" id="tasksLink" class="active">Tasks</a></li>
            <li><a href="#summary" id="summaryLink">Summary</a></li>
            <li><a href="#agenda" id="agendaLink">Agenda</a></li>
            <li><a href="#focus" id="focusLink">Focus</a></li>
            <li><a href="#rest" id="restLink">Rest</a></li>
        </ul>
    </nav>

    <section id="tasks" class="active noselect">
        <textarea id="taskTextarea" placeholder="task:step:hour\n!prioritytask:step:hour\n+completedtask:step:hour"></textarea>
        <button id="saveTasksBtn">Save</button>
    </section>

    <section id="summary" class="noselect">
        <h3>Daily Summary</h3>
        <ul id="summaryList"></ul>
        <h3>Weekly Summary (Past 7 Days)</h3>
        <ul id="weeklySummaryList"></ul>
    </section>

    <section id="agenda" class="noselect">
        <table id="agendaTable">
            <thead><tr><th>Hour</th><th>Task Worked</th></tr></thead>
            <tbody></tbody>
        </table>
        <textarea id="meetingsTextarea" placeholder="09:00: Team Meeting\n10:30: Client Call"></textarea>
        <div id="contextLog"></div>
    </section>

    <section id="focus" class="noselect">
        <select id="taskSelect"></select>
        <input id="stepInput" placeholder="Step">
        <textarea id="notesTextarea" placeholder="Notes for task"></textarea>
        <button id="saveFocusBtn">Save</button>
        <div id="currentTaskDisplayFocus"></div>
        <div id="timeRemainingFocus">12:00</div>
        <div id="timerBarFocus"><div id="timerProgressFocus">&nbsp;</div></div>
        <div id="extendLinksFocus">Extend: <a>+1</a> <a>+2</a> <a>+5</a> <a>+10</a></div>
        <div id="setLinksFocus">Set: <a>10s</a> <a>3m</a> <a>5m</a> <a>10m</a> <a>12m</a> <a>15m</a> <a>20m</a> <a>30m</a></div>
        <div id="timerControlsFocus"> <a id="startFocus">Start</a> <a id="stopFocus">Stop</a> <a id="resetFocus">Reset</a> </div>
        <button id="openNoteTray">Open Note Tray</button>
        <div id="noteTrayContainer">
            <textarea id="noteTrayTextarea" placeholder="Random notes..."></textarea>
            <button id="closeNoteTray">Close Note Tray</button>
        </div>
    </section>

    <section id="rest" class="noselect">
        <div id="currentTaskDisplayRest">Resting</div>
        <div id="timeRemainingRest">03:00</div>
        <div id="timerBarRest"><div id="timerProgressRest">&nbsp;</div></div>
        <div id="extendLinksRest">Extend: <a>+1</a> <a>+2</a> <a>+5</a> <a>+10</a></div>
        <div id="setLinksRest">Set: <a>10s</a> <a>3m</a> <a>5m</a> <a>10m</a> <a>12m</a> <a>15m</a> <a>20m</a> <a>30m</a></div>
        <div id="timerControlsRest"> <a id="startRest">Start</a> <a id="stopRest">Stop</a> <a id="resetRest">Reset</a> </div>
    </section>

    <a id="settingsLink" title="Settings">‚öôÔ∏è</a>
    <a id="refreshLink" title="Refresh" style="position: fixed; bottom: 10px; left: 40px; font-size: 0.8em; color: #777; text-decoration: none; cursor: pointer;">üîÑ</a>
    <a id="syncLink" title="Manual Sync">Sync: Disabled</a>
    <a id="activateLink" title="Activate" style="position: fixed; bottom: 10px; left: 10px; font-size: 0.8em; color: #777; text-decoration: none; cursor: pointer;">Activate</a>
    <div id="activeIndicator">Inactive</div>
    <div id="settingsContainer">
        <h3>Settings</h3>
        <label>Timestamp URL: <input id="timestampUrlInput" placeholder="Enter timestamp API URL"></label>
        <label>Data URL: <input id="dataUrlInput" placeholder="Enter data API URL"></label>
        <label>Focus Timer (min): <input id="focusTimerInput" type="number" min="1" value="12"></label>
        <label>Rest Timer (min): <input id="restTimerInput" type="number" min="1" value="3"></label>
        <label>Indent Size (spaces): <input id="indentSizeInput" type="number" min="1" max="8" value="4"></label>
        <label>Theme: <select id="themeSelect"><option value="light">Light</option><option value="dark">Dark</option></select></label>
        <label>Active Sync Interval (sec): <input id="activeSyncIntervalInput" type="number" min="10" value="30"></label>
        <label>Inactive Sync Interval (min): <input id="inactiveSyncIntervalInput" type="number" min="1" value="5"></label>
        <button id="saveSettingsBtn">Save Settings</button>
        <button id="closeSettingsBtn">Close</button>
    </div>

    <script>
        // Data structure
        let data = {
            rawTasks: '',
            tasks: [],
            currentTask: null,
            timers: {
                focus: { initial: 720, remaining: 720, accumulated: 0, running: false, interval: null, overtime: false },
                rest: { initial: 180, remaining: 180, accumulated: 0, running: false, interval: null, overtime: false },
                plan: { accumulated: 0, running: false, interval: null }
            },
            log: {},
            meetings: '',
            noteTray: ''
        };

        const STORAGE_KEY = 'focusAppData';
        const SETTINGS_KEY = 'focusAppSettings';
        let TODAY = new Date().toISOString().split('T')[0];
        const DEFAULT_TASKS = [
            'rest::0',
            'plan::0',
            'misc::0',
            'meeting::0',
            'break::0'
        ];

        let settings = {
            timestampUrl: '',
            dataUrl: '',
            focusTimer: 12,
            restTimer: 3,
            indentSize: 4,
            theme: 'light',
            activeSyncInterval: 30,
            inactiveSyncInterval: 5
        };

        let isActiveInstance = true;
        let lastStored = { timestamp: 0, version: 0 };
        let lastInteraction = Date.now();

        // Load settings
        function loadSettings() {
            const saved = localStorage.getItem(SETTINGS_KEY);
            if (saved) settings = { ...settings, ...JSON.parse(saved) };
            data.timers.focus.initial = data.timers.focus.remaining = (settings.focusTimer || 12) * 60;
            data.timers.rest.initial = data.timers.rest.remaining = (settings.restTimer || 3) * 60;
            document.body.className = settings.theme === 'dark' ? 'dark-mode' : '';
            document.getElementById('timestampUrlInput').value = settings.timestampUrl;
            document.getElementById('dataUrlInput').value = settings.dataUrl;
            document.getElementById('focusTimerInput').value = settings.focusTimer;
            document.getElementById('restTimerInput').value = settings.restTimer;
            document.getElementById('indentSizeInput').value = settings.indentSize;
            document.getElementById('themeSelect').value = settings.theme;
            document.getElementById('activeSyncIntervalInput').value = settings.activeSyncInterval;
            document.getElementById('inactiveSyncIntervalInput').value = settings.inactiveSyncInterval;
            updateTimerDisplay('focus');
            updateTimerDisplay('rest');
            updateSyncStatus(false); // NEW: Initialize sync status
            if (!settings.timestampUrl || !settings.dataUrl) {
                isActiveInstance = true;
            }
        }

        // Handle Activate/Deactivate logic
        function toggleActiveStatus() {
            if (isActiveInstance) {
                isActiveInstance = false;
                updateSyncStatus(false); // Show inactive status immediately
                stopVisibleTimers(); // Stop any active timers
            } else {
                isActiveInstance = true;
                updateSyncStatus(true); // Show active status immediately
                loadDataFromDataUrl(); // Fetch latest data before claiming active
                simpleCloudStore(data); // Proceed with claiming active
            }
        }

        async function loadDataFromDataUrl() {
            if (settings.dataUrl) {
                const response = await fetch(settings.dataUrl);
                const freshData = await response.json();
                data = mergeData(data, freshData); // Merge new data into local data
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); // Save to localStorage
            }
        }

        function updateSyncStatus(isActive, error = false) {
            const activeIndicator = document.getElementById('activeIndicator');
            const syncLink = document.getElementById('syncLink');
            const syncMessage = isActive ? 'Active' : 'Inactive';
            activeIndicator.textContent = syncMessage;
            syncLink.textContent = isActive ? 'Sync: Active' : 'Sync: Inactive';
            if (error) {
                syncLink.textContent = 'Sync: Failed';
                activeIndicator.textContent = 'Sync Failed';
            }
        }

        // Sync process logic
        async function simpleCloudStore(dataToSend) {
            if (!settings.timestampUrl || !settings.dataUrl) {
                updateSyncStatus(false);
                return;
            }

            try {
                const tsResponse = await fetch(settings.timestampUrl);
                let remoteMeta = { timestamp: 0, version: 0 };
                try {
                    const text = await tsResponse.text();
                    remoteMeta = text ? JSON.parse(text) : { timestamp: 0, version: 0 };
                } catch (e) {
                    console.warn('Invalid timestamp response, defaulting to 0:', e);
                }

                if (dataToSend) {
                    await fetch(settings.dataUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `v=${encodeURIComponent(JSON.stringify(dataToSend))}`
                    });

                    await fetch(settings.timestampUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `v=${encodeURIComponent(JSON.stringify({ timestamp: lastStored.timestamp, version: lastStored.version }))}`
                    });
                    updateSyncStatus(true);
                } else if (remoteMeta.timestamp > lastStored.timestamp) {
                    const response = await fetch(settings.dataUrl);
                    let remoteData = {};
                    try {
                        const text = await response.text();
                        remoteData = text ? JSON.parse(text) : data;
                    } catch (e) {
                        console.warn('Invalid data response, skipping sync:', e);
                        updateSyncStatus(false, true);
                        return;
                    }

                    data = mergeData(data, remoteData);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                    lastStored = { ...remoteMeta };
                    isActiveInstance = false;
                    stopVisibleTimers();
                    loadData();
                    updateSyncStatus(false);
                } else if (remoteMeta.timestamp < lastStored.timestamp) {
                    await simpleCloudStore(data);
                }
            } catch (e) {
                console.error('Sync failed:', e);
                updateSyncStatus(false, true);
            }
        }

        // Merge logic
        function mergeData(local, remote) {
            const merged = { ...local, ...remote };
            const allTasks = [...local.tasks, ...remote.tasks.filter(rt => !local.tasks.find(lt => lt.name === rt.name))];
            merged.tasks = allTasks.sort((a, b) => {
                const aTime = (a.durations[TODAY]?.sessions?.slice(-1)[0]?.end || 0);
                const bTime = (b.durations[TODAY]?.sessions?.slice(-1)[0]?.end || 0);
                return bTime - aTime;
            });

            merged.log = {};
            for (let date in local.log) {
                merged.log[date] = [...(local.log[date] || [])];
            }
            for (let date in remote.log) {
                const remoteEntries = remote.log[date] || [];
                merged.log[date] = [...(merged.log[date] || []), ...remoteEntries.filter(re => !merged.log[date]?.find(le => le.time === re.time))]
                    .sort((a, b) => new Date(a.time) - new Date(b.time));
            }

            merged.tasks.forEach(task => {
                const localDurations = task.durations || {};
                const remoteDurations = (remote.tasks.find(rt => rt.name === task.name) || {}).durations || {};
                task.durations = {};
                for (let date in localDurations) {
                    task.durations[date] = { ...localDurations[date], sessions: [...(localDurations[date].sessions || [])] };
                }
                for (let date in remoteDurations) {
                    const remoteSessions = remoteDurations[date]?.sessions || [];
                    task.durations[date] = task.durations[date] || { minutes: 0, sessions: [] };
                    task.durations[date].sessions = [
                        ...(task.durations[date].sessions || []),
                        ...remoteSessions.filter(rs => !task.durations[date].sessions.find(ls => ls.start === rs.start))
                    ];
                    task.durations[date].minutes = task.durations[date].sessions.reduce((sum, s) => sum + ((s.end || Date.now()) - s.start) / 1000 / 60, 0);
                }
            });
            return merged;
        }
        
        // Manual sync
        document.getElementById('syncLink').addEventListener('click', () => {
            if (!settings.timestampUrl || !settings.dataUrl) {
                alert('Sync disabled: Please set both Timestamp URL and Data URL in settings.');
                return;
            }
            isActiveInstance = true;
            simpleCloudStore(data);
        });

        // Activate button logic
        document.getElementById('activateLink').addEventListener('click', toggleActiveStatus);

        // Initial load
        loadSettings();

    </script>
</body>
</html>
